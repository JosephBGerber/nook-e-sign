BUILD_TOOLS="$ANDROID_SDK_ROOT/build-tools/19.1.0"
PLATFORM="$ANDROID_SDK_ROOT/platforms/android-7"

ANDROID_ROOT="$WORKSPACE/android"
APP_DIR="$ANDROID_ROOT/app"
SRC_DIR="$APP_DIR/src/main"
JAVA_DIR="$SRC_DIR/java"
BUILD_DIR="$APP_DIR/build"

mkdir -p $BUILD_DIR
cd $BUILD_DIR

$BUILD_TOOLS/aapt package -m -J $JAVA_DIR -M $SRC_DIR/AndroidManifest.xml -S $SRC_DIR/res/ -I $PLATFORM/android.jar

rm -r obj
mkdir obj

javac -d obj -source 1.7 -target 1.7 -classpath "$JAVA_DIR" -bootclasspath $PLATFORM/android.jar $JAVA_DIR/com/github/josephbgerber/nookesign/*.java
javac -d obj -source 1.7 -target 1.7 -classpath "$JAVA_DIR" -bootclasspath $PLATFORM/android.jar $JAVA_DIR/mjson/*.java

$BUILD_TOOLS/dx --dex --output=classes.dex obj

$BUILD_TOOLS/aapt package -f -M $SRC_DIR/AndroidManifest.xml -S $SRC_DIR/res/ -I $PLATFORM/android.jar -F NookTouchSign.apk.unaligned

$BUILD_TOOLS/aapt add -f NookTouchSign.apk.unaligned classes.dex

jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -storepass "\$3ADE68b1\$" -keystore $KEYSTORE NookTouchSign.apk.unaligned key0

rm -f NookTouchSign.apk

$BUILD_TOOLS/zipalign 4 NookTouchSign.apk.unaligned NookTouchSign.apk
